<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="favicon.png">
    <title>ZIP Tree Viewer</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }
        
        body {
            background: #1e1e1e;
            color: #d4d4d4;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #252526;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        
        header {
            background: #0e2941;
            color: #d4d4d4;
            padding: 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .header-info {
            flex: 1;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: #569cd6;
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.8;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .upload-section {
            padding: 25px;
            text-align: center;
            border-bottom: 1px solid #3e3e42;
        }
        
        .upload-area {
            border: 2px dashed #569cd6;
            border-radius: 6px;
            padding: 30px 20px;
            margin: 20px 0;
            transition: all 0.3s;
            background-color: #2d2d30;
            cursor: pointer;
        }
        
        .upload-area:hover {
            background-color: #323233;
            border-color: #4ec9b0;
        }
        
        .upload-area.highlight {
            background-color: #323233;
            border-color: #4ec9b0;
        }
        
        .upload-icon {
            font-size: 40px;
            color: #569cd6;
            margin-bottom: 10px;
        }
        
        .upload-text {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #d4d4d4;
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn:hover {
            background: #1177bb;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #464647;
        }
        
        .btn-secondary:hover {
            background: #525253;
        }
        
        .btn-success {
            background: #2d7d2d;
        }
        
        .btn-success:hover {
            background: #358c35;
        }
        
        .btn-warning {
            background: #d16969;
        }
        
        .btn-warning:hover {
            background: #d18669;
        }
        
        .result-section {
            padding: 25px;
            display: none;
        }
        
        .controls-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 8px 12px;
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            color: #d4d4d4;
        }
        
        .search-results {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            color: #6a9955;
        }
        
        .view-options {
            display: flex;
            gap: 5px;
        }
        
        .view-options .btn {
            padding: 8px 12px;
        }
        
        .view-options .btn.active {
            background: #569cd6;
        }
        
        .file-info {
            background-color: #2d2d30;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #569cd6;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .archive-info {
            background: #2d2d30;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 4px solid #6a9955;
        }
        
        .file-structure {
            background-color: #1e1e1e;
            border-radius: 6px;
            padding: 20px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            max-height: 500px;
            overflow-y: auto;
            white-space: pre;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .file-structure.list {
            white-space: normal;
        }
        
        .file-structure.grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            white-space: normal;
        }
        
        .tree-output {
            color: #d4d4d4;
        }
        
        .tree-folder {
            color: #569cd6;
            font-weight: bold;
        }
        
        .tree-file {
            color: #d4d4d4;
        }
        
        .tree-line {
            color: #6a9955;
        }
        
        .file-item {
            padding: 8px 10px;
            border-bottom: 1px solid #2d2d30;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .file-item:hover {
            background: #2d2d30;
        }
        
        .file-item.large-file {
            background: rgba(255, 100, 100, 0.1);
            border-left: 3px solid #ff6b6b;
        }
        
        .file-item.folder {
            font-weight: bold;
            color: #569cd6;
        }
        
        .file-icon {
            font-size: 1.2rem;
        }
        
        .file-name {
            flex: 1;
        }
        
        .file-size {
            color: #6a9955;
            font-size: 0.8rem;
        }
        
        .file-content {
            background: #1e1e1e;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow: auto;
            display: none;
        }
        
        .file-content-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #3e3e42;
        }
        
        .file-content pre {
            white-space: pre-wrap;
            font-family: 'Consolas', monospace;
            line-height: 1.4;
        }
        
        .binary-warning {
            text-align: center;
            padding: 40px;
            color: #d18669;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .spinner {
            border: 4px solid #2d2d30;
            border-top: 4px solid #569cd6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #858585;
        }
        
        .empty-icon {
            font-size: 40px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #858585;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat-item {
            background: #2d2d30;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #569cd6;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #858585;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .header-controls {
                justify-content: center;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .upload-section, .result-section {
                padding: 15px;
            }
            
            .file-info {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-info">
                <h1>ZIP Tree Viewer</h1>
                <p class="subtitle">View the structure and contents of ZIP archives</p>
            </div>
            <div class="header-controls">
                <button class="btn btn-secondary" id="historyBtn">üìö History</button>
                <button class="btn btn-secondary" id="helpBtn">‚ùì Help</button>
            </div>
        </header>
        
        <section class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <p class="upload-text">Drag and drop a ZIP file here or click to select</p>
                <button class="btn" id="browseBtn">üìÅ Select File</button>
                <input type="file" id="fileInput" class="file-input" accept=".zip">
            </div>
        </section>
        
        <section class="result-section" id="resultSection">
            <div class="controls-row">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search files...">
                    <span class="search-results" id="searchResults"></span>
                </div>
                <div class="view-options">
                    <button class="btn active" data-view="tree">üå≥ Tree</button>
                    <button class="btn" data-view="list">üìã List</button>
                    <button class="btn" data-view="grid">üî≤ Grid</button>
                </div>
                <button class="btn btn-success" id="copyBtn">üìã Copy</button>
                <button class="btn btn-secondary" id="exportBtn">üíæ Export</button>
                <button class="btn btn-warning" id="resetBtn">üîÑ New File</button>
            </div>
            
            <div class="file-info">
                <div>
                    <strong id="fileName"></strong>
                    <div id="fileDetails"></div>
                </div>
                <div id="fileStats"></div>
            </div>
            
            <div class="archive-info" id="archiveInfo"></div>
            
            <div class="file-structure tree" id="fileStructure">
                <!-- File structure will be displayed here -->
            </div>
            
            <div class="file-content" id="fileContent">
                <div class="file-content-header">
                    <strong id="contentFileName"></strong>
                    <button class="btn btn-secondary" id="closeContentBtn">‚úï Close</button>
                </div>
                <pre id="contentText"></pre>
            </div>
        </section>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Analyzing archive...</p>
        </div>
    </div>
    
    <footer>
        <p>¬© 2025 ZIP Tree Viewer | All files are processed locally in your browser</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            const resultSection = document.getElementById('resultSection');
            const fileStructure = document.getElementById('fileStructure');
            const fileName = document.getElementById('fileName');
            const fileDetails = document.getElementById('fileDetails');
            const fileStats = document.getElementById('fileStats');
            const archiveInfo = document.getElementById('archiveInfo');
            const resetBtn = document.getElementById('resetBtn');
            const browseBtn = document.getElementById('browseBtn');
            const copyBtn = document.getElementById('copyBtn');
            const exportBtn = document.getElementById('exportBtn');
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const viewButtons = document.querySelectorAll('.view-options .btn');
            const loading = document.getElementById('loading');
            const fileContent = document.getElementById('fileContent');
            const contentFileName = document.getElementById('contentFileName');
            const contentText = document.getElementById('contentText');
            const closeContentBtn = document.getElementById('closeContentBtn');
            const historyBtn = document.getElementById('historyBtn');
            const helpBtn = document.getElementById('helpBtn');

            let currentZip = null;
            let currentView = 'tree';
            let allFiles = [];

            // Initialization
            init();

            function init() {
                setupEventListeners();
                loadHistory();
            }

            function setupEventListeners() {
                // Main handlers
                browseBtn.addEventListener('click', () => {
                    fileInput.value = '';
                    fileInput.click();
                });

                uploadArea.addEventListener('click', (e) => {
                    if (e.target !== browseBtn) {
                        fileInput.value = '';
                        fileInput.click();
                    }
                });

                fileInput.addEventListener('change', function() {
                    if (this.files.length > 0) {
                        handleFiles(this.files);
                    }
                });

                // Drag & Drop
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, preventDefaults, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, highlight, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, unhighlight, false);
                });

                uploadArea.addEventListener('drop', handleDrop, false);

                // Control buttons
                resetBtn.addEventListener('click', resetForm);
                copyBtn.addEventListener('click', copyStructure);
                exportBtn.addEventListener('click', exportToText);
                closeContentBtn.addEventListener('click', closeFileContent);

                // Search
                searchInput.addEventListener('input', performSearch);

                // View modes
                viewButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        viewButtons.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        currentView = this.dataset.view;
                        fileStructure.className = `file-structure ${currentView}`;
                        renderFileStructure();
                    });
                });

                // Additional buttons
                historyBtn.addEventListener('click', showHistory);
                helpBtn.addEventListener('click', showHelp);
            }

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function highlight() {
                uploadArea.classList.add('highlight');
            }

            function unhighlight() {
                uploadArea.classList.remove('highlight');
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    handleFiles(files);
                }
            }

            function handleFiles(files) {
                const file = files[0];
                if (!file.name.toLowerCase().endsWith('.zip')) {
                    alert('Please select a file with .zip extension');
                    return;
                }

                showLoading(true);
                fileName.textContent = file.name;
                fileDetails.textContent = `Size: ${formatFileSize(file.size)}`;

                processZipFile(file);
            }

            function processZipFile(file) {
                const zip = new JSZip();
                currentZip = zip;

                zip.loadAsync(file)
                    .then(function(zip) {
                        allFiles = Object.keys(zip.files);
                        displayArchiveInfo(zip, file);
                        renderFileStructure();
                        showLoading(false);
                        resultSection.style.display = 'block';
                        saveToHistory({
                            name: file.name,
                            size: file.size,
                            date: new Date().toISOString()
                        });
                    })
                    .catch(function(error) {
                        console.error('Error reading ZIP archive:', error);
                        showError('Failed to read ZIP archive. Make sure the file is not corrupted.');
                        showLoading(false);
                    });
            }

            function displayArchiveInfo(zip, file) {
                const totalFiles = allFiles.filter(path => !path.endsWith('/')).length;
                const totalFolders = allFiles.filter(path => path.endsWith('/')).length;
                const totalSize = Object.values(zip.files).reduce((sum, file) => 
                    sum + file._data.uncompressedSize, 0);
                
                const fileTypes = getFileTypeStats(zip);
                const compressionRatio = ((file.size / totalSize) * 100).toFixed(1);

                archiveInfo.innerHTML = `
                    <strong>üìä Archive Information:</strong>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">${totalFiles}</div>
                            <div class="stat-label">Files</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${totalFolders}</div>
                            <div class="stat-label">Folders</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${formatFileSize(totalSize)}</div>
                            <div class="stat-label">Total Size</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${compressionRatio}%</div>
                            <div class="stat-label">Compression</div>
                        </div>
                    </div>
                `;

                // Update statistics in fileStats
                const topExtensions = Object.entries(fileTypes)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3)
                    .map(([ext, count]) => `${ext}: ${count}`)
                    .join(', ');

                fileStats.innerHTML = `File types: ${topExtensions}`;
                fileDetails.textContent += ` | Files: ${totalFiles} | Folders: ${totalFolders}`;
            }

            function renderFileStructure() {
                if (!currentZip) return;

                if (currentView === 'tree') {
                    renderTreeView();
                } else if (currentView === 'list') {
                    renderListView();
                } else if (currentView === 'grid') {
                    renderGridView();
                }
            }

            function renderTreeView() {
                let treeOutput = '';
                let fileCount = 0;
                let folderCount = 0;

                const root = { name: '', children: {}, isRoot: true };
                
                allFiles.forEach(path => {
                    if (path.endsWith('/')) return;
                    
                    const parts = path.split('/').filter(part => part !== '');
                    let current = root;
                    
                    for (let i = 0; i < parts.length; i++) {
                        const part = parts[i];
                        const isFile = i === parts.length - 1;
                        
                        if (!current.children[part]) {
                            current.children[part] = {
                                name: part,
                                children: {},
                                isFile: isFile,
                                isFolder: !isFile,
                                path: path,
                                size: isFile ? currentZip.files[path]._data.uncompressedSize : 0
                            };
                        }
                        
                        if (!isFile) {
                            current = current.children[part];
                        }
                    }
                });

                function buildTree(node, prefix = '', isLast = true) {
                    const entries = Object.values(node.children);
                    if (entries.length === 0) return;
                    
                    entries.sort((a, b) => {
                        if (a.isFolder && !b.isFolder) return -1;
                        if (!a.isFolder && b.isFolder) return 1;
                        return a.name.localeCompare(b.name);
                    });
                    
                    entries.forEach((entry, index) => {
                        const isLastEntry = index === entries.length - 1;
                        const connector = isLastEntry ? '‚îî‚îÄ‚îÄ ' : '‚îú‚îÄ‚îÄ ';
                        const currentPrefix = isLastEntry ? '    ' : '‚îÇ   ';
                        
                        if (entry.isFolder) {
                            folderCount++;
                            treeOutput += prefix + connector + '<span class="tree-folder">' + entry.name + '</span>\n';
                            buildTree(entry, prefix + currentPrefix, isLastEntry);
                        } else {
                            fileCount++;
                            const size = entry.size ? ` <span class="tree-line">[${formatFileSize(entry.size)}]</span>` : '';
                            treeOutput += prefix + connector + 
                                `<span class="tree-file" data-path="${entry.path}" data-size="${entry.size}">${entry.name}</span>` + 
                                size + '\n';
                        }
                    });
                }

                treeOutput += '<span class="tree-line">.</span>\n';
                buildTree(root, '', true);
                
                treeOutput += '\n<span class="tree-line">' + 
                             folderCount + ' directories, ' + 
                             fileCount + ' files</span>\n';

                fileStructure.innerHTML = '<div class="tree-output">' + treeOutput + '</div>';

                // Add click handlers for files
                document.querySelectorAll('.tree-file').forEach(el => {
                    el.style.cursor = 'pointer';
                    el.addEventListener('click', function() {
                        const filePath = this.dataset.path;
                        showFileContent(filePath);
                    });
                });
            }

            function renderListView() {
                let html = '';
                const files = allFiles.filter(path => !path.endsWith('/'))
                    .sort((a, b) => a.localeCompare(b));

                files.forEach(path => {
                    const file = currentZip.files[path];
                    const name = path.split('/').pop();
                    const size = file._data.uncompressedSize;
                    const icon = getFileIcon(name);
                    const isLarge = size > 1024 * 1024; // > 1MB
                    
                    html += `
                        <div class="file-item ${isLarge ? 'large-file' : ''}" data-path="${path}">
                            <span class="file-icon">${icon}</span>
                            <span class="file-name">${name}</span>
                            <span class="file-size">${formatFileSize(size)}</span>
                        </div>
                    `;
                });

                fileStructure.innerHTML = html;

                // Add click handlers
                document.querySelectorAll('.file-item').forEach(el => {
                    el.addEventListener('click', function() {
                        const filePath = this.dataset.path;
                        showFileContent(filePath);
                    });
                });
            }

            function renderGridView() {
                let html = '';
                const files = allFiles.filter(path => !path.endsWith('/'))
                    .sort((a, b) => a.localeCompare(b));

                files.forEach(path => {
                    const file = currentZip.files[path];
                    const name = path.split('/').pop();
                    const size = file._data.uncompressedSize;
                    const icon = getFileIcon(name);
                    const isLarge = size > 1024 * 1024;
                    
                    html += `
                        <div class="file-item ${isLarge ? 'large-file' : ''}" data-path="${path}">
                            <div style="text-align: center;">
                                <div class="file-icon" style="font-size: 2rem;">${icon}</div>
                                <div class="file-name" style="word-break: break-word; margin: 5px 0;">${name}</div>
                                <div class="file-size">${formatFileSize(size)}</div>
                            </div>
                        </div>
                    `;
                });

                fileStructure.innerHTML = html;

                document.querySelectorAll('.file-item').forEach(el => {
                    el.addEventListener('click', function() {
                        const filePath = this.dataset.path;
                        showFileContent(filePath);
                    });
                });
            }

            async function showFileContent(filePath) {
                if (!currentZip) return;

                showLoading(true);
                
                try {
                    const file = currentZip.files[filePath];
                    contentFileName.textContent = filePath;
                    
                    // Check if the file is text-based
                    const extension = filePath.split('.').pop().toLowerCase();
                    const textExtensions = ['txt', 'md', 'c', 'h', 'cpp', 'hpp', 'js', 'html', 'css', 'py', 'java', 'json', 'xml', 'csv', 'log', 'cfg', 'conf', 'ini', 'rs', 'asm'];
                    
                    if (textExtensions.includes(extension)) {
                        const content = await file.async('text');
                        contentText.textContent = content;
                        contentText.style.display = 'block';
                        fileContent.querySelector('.binary-warning')?.remove();
                    } else {
                        contentText.style.display = 'none';
                        if (!fileContent.querySelector('.binary-warning')) {
                            const warning = document.createElement('div');
                            warning.className = 'binary-warning';
                            warning.innerHTML = `
                                <div style="font-size: 3rem; margin-bottom: 10px;">üîí</div>
                                <p>This file cannot be displayed as text</p>
                                <p style="font-size: 0.8rem; margin-top: 10px;">Format: ${extension || 'unknown'}</p>
                            `;
                            fileContent.appendChild(warning);
                        }
                    }
                    
                    fileContent.style.display = 'block';
                    fileContent.scrollIntoView({ behavior: 'smooth' });
                } catch (error) {
                    console.error('Error reading file:', error);
                    contentText.textContent = 'Error reading file';
                }
                
                showLoading(false);
            }

            function closeFileContent() {
                fileContent.style.display = 'none';
            }

            function performSearch() {
                const query = searchInput.value.toLowerCase();
                if (!query) {
                    searchResults.textContent = '';
                    renderFileStructure();
                    return;
                }

                const results = allFiles.filter(path => 
                    path.toLowerCase().includes(query) && !path.endsWith('/')
                );

                searchResults.textContent = `Found: ${results.length}`;

                // Highlight results in current view
                if (currentView === 'tree') {
                    highlightInTree(results);
                } else {
                    highlightInList(results);
                }
            }

            function highlightInTree(results) {
                const treeOutput = document.querySelector('.tree-output');
                if (!treeOutput) return;

                let html = treeOutput.innerHTML;
                results.forEach(path => {
                    const fileName = path.split('/').pop();
                    const regex = new RegExp(`(${fileName})`, 'gi');
                    html = html.replace(regex, '<mark>$1</mark>');
                });
                treeOutput.innerHTML = html;
            }

            function highlightInList(results) {
                document.querySelectorAll('.file-item').forEach(item => {
                    const path = item.dataset.path;
                    if (results.includes(path)) {
                        item.style.background = 'rgba(86, 156, 214, 0.2)';
                        item.style.borderLeft = '3px solid #569cd6';
                    } else {
                        item.style.background = '';
                        item.style.borderLeft = '';
                    }
                });
            }

            function copyStructure() {
                const text = currentView === 'tree' 
                    ? document.querySelector('.tree-output').textContent
                    : generateTextStructure();
                
                navigator.clipboard.writeText(text).then(() => {
                    copyBtn.textContent = '‚úÖ Copied!';
                    setTimeout(() => copyBtn.textContent = 'üìã Copy', 2000);
                });
            }

            function exportToText() {
                const text = currentView === 'tree' 
                    ? document.querySelector('.tree-output').textContent
                    : generateTextStructure();
                
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${fileName.textContent || 'archive'}_structure.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }

            function generateTextStructure() {
                let text = `Archive structure: ${fileName.textContent}\n\n`;
                allFiles.filter(path => !path.endsWith('/')).forEach(path => {
                    const file = currentZip.files[path];
                    text += `${path} [${formatFileSize(file._data.uncompressedSize)}]\n`;
                });
                return text;
            }

            function resetForm() {
                resultSection.style.display = 'none';
                fileInput.value = '';
                fileStructure.innerHTML = '';
                fileName.textContent = '';
                fileDetails.textContent = '';
                fileStats.innerHTML = '';
                archiveInfo.innerHTML = '';
                searchInput.value = '';
                searchResults.textContent = '';
                fileContent.style.display = 'none';
                currentZip = null;
                allFiles = [];
            }

            function showLoading(show) {
                loading.style.display = show ? 'block' : 'none';
            }

            function showError(message) {
                fileStructure.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <p>${message}</p>
                    </div>
                `;
            }

            // Helper functions
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            function getFileIcon(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const icons = {
                    'c': 'üìü', 'h': 'üìü', 'cpp': 'üìü', 'hpp': 'üìü',
                    'rs': 'ü¶Ä', 
                    'asm': '‚öôÔ∏è', 's': '‚öôÔ∏è',
                    'cfg': '‚öôÔ∏è', 'mk': '‚öôÔ∏è', 'ld': '‚öôÔ∏è', 'ini': '‚öôÔ∏è', 'conf': '‚öôÔ∏è',
                    'txt': 'üìÑ', 'log': 'üìÑ',
                    'md': 'üìñ',
                    'py': 'üêç', 'js': 'üìú', 'html': 'üåê', 'css': 'üé®', 'php': 'üêò',
                    'json': 'üìã', 'xml': 'üìã', 'yaml': 'üìã', 'yml': 'üìã',
                    'zip': 'üì¶', 'rar': 'üì¶', 'tar': 'üì¶', 'gz': 'üì¶',
                    'exe': '‚ö°', 'dll': '‚ö°', 'so': '‚ö°',
                    'jpg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'gif': 'üñºÔ∏è', 'svg': 'üñºÔ∏è', 'ico': 'üñºÔ∏è',
                    'pdf': 'üìï', 'doc': 'üìò', 'docx': 'üìò'
                };
                return icons[ext] || 'üìÑ';
            }

            function getFileTypeStats(zip) {
                const extensions = {};
                allFiles.forEach(path => {
                    if (!path.endsWith('/')) {
                        const ext = path.split('.').pop().toLowerCase() || 'no extension';
                        extensions[ext] = (extensions[ext] || 0) + 1;
                    }
                });
                return extensions;
            }

            function saveToHistory(fileInfo) {
                const history = JSON.parse(localStorage.getItem('zipHistory') || '[]');
                const existingIndex = history.findIndex(item => item.name === fileInfo.name);
                if (existingIndex !== -1) {
                    history.splice(existingIndex, 1);
                }
                history.unshift(fileInfo);
                localStorage.setItem('zipHistory', JSON.stringify(history.slice(0, 10)));
            }

            function loadHistory() {
                // Can implement history display
            }

            function showHistory() {
                alert('History feature will be implemented in the next version!');
            }

            function showHelp() {
                alert(`ZIP Tree Viewer - Help

üìÅ Uploading files:
‚Ä¢ Drag and drop a ZIP file into the designated area
‚Ä¢ Or click "Select File"

üîç Search:
‚Ä¢ Use the search field to quickly find files

üëÅÔ∏è View modes:
‚Ä¢ üå≥ Tree - tree structure
‚Ä¢ üìã List - file list
‚Ä¢ üî≤ Grid - grid with icons

üìÑ Viewing files:
‚Ä¢ Click on any file to view its contents
‚Ä¢ Text formats are supported

üìã Actions:
‚Ä¢ Copy structure to clipboard
‚Ä¢ Export structure to text file

üí° All files are processed locally in your browser!`);
            }
        });
    </script>
    
    <!-- Include JSZip library for working with ZIP archives -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
           // –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
           function analyzeFileSecurity(file) {
               const warnings = [];
               
               // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
               if (file.size > 100 * 1024 * 1024) { // 100MB
                   warnings.push({
                       type: 'size',
                       message: '–§–∞–π–ª –æ—á–µ–Ω—å –±–æ–ª—å—à–æ–π (>100MB)',
                       severity: 'warning'
                   });
               }
               
               // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–∞
               const dangerousExtensions = [
                   'exe', 'scr', 'bat', 'cmd', 'ps1', 'vbs', 'js', 'jar', 
                   'msi', 'com', 'pif', 'application', 'gadget', 'msc',
                   'msp', 'hta', 'cpl', 'msh', 'msh1', 'msh2', 'mshxml',
                   'msh1xml', 'msh2xml', 'scf', 'lnk', 'inf', 'reg'
               ];
               
               const fileExtension = file.name.split('.').pop().toLowerCase();
               if (dangerousExtensions.includes(fileExtension)) {
                   warnings.push({
                       type: 'extension',
                       message: `–û–ø–∞—Å–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞: .${fileExtension}`,
                       severity: 'danger'
                   });
               }
               
               // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–≤–æ–π–Ω—ã—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
               if (file.name.includes('..') || file.name.match(/\.[a-z]{3,4}\.[a-z]{2,4}$/i)) {
                   warnings.push({
                       type: 'double_extension',
                       message: '–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –¥–≤–æ–π–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ',
                       severity: 'danger'
                   });
               }
               
               // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∫—Ä—ã—Ç—ã–µ —Ñ–∞–π–ª—ã
               if (file.name.startsWith('.') || file.name.toLowerCase().includes('thumbs.db')) {
                   warnings.push({
                       type: 'hidden',
                       message: '–°–∫—Ä—ã—Ç—ã–π –∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–π —Ñ–∞–π–ª',
                       severity: 'warning'
                   });
               }
               
               return warnings;
           }
   
           function displaySecurityWarnings(warnings, fileName) {
               let html = `
                   <div class="security-check ${warnings.length === 0 ? 'safe' : 'warning'}">
                       <strong>üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: ${fileName}</strong>
               `;
               
               if (warnings.length === 0) {
                   html += `
                       <div class="security-item">
                           <span class="security-icon">‚úÖ</span>
                           <span>–§–∞–π–ª –ø—Ä–æ—à–µ–ª –±–∞–∑–æ–≤—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</span>
                       </div>
                   `;
               } else {
                   warnings.forEach(warning => {
                       const icon = warning.severity === 'danger' ? 'üö´' : '‚ö†Ô∏è';
                       html += `
                           <div class="security-item">
                               <span class="security-icon">${icon}</span>
                               <span>${warning.message}</span>
                           </div>
                       `;
                   });
                   
                   html += `
                       <div class="security-warning">
                           <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏. 
                           –û—Ç–∫—Ä—ã–≤–∞–π—Ç–µ –µ–≥–æ —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é.
                       </div>
                   `;
               }
               
               html += '</div>';
               return html;
           }
   
           // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞
           async function showFileContent(filePath) {
               if (!currentZip) return;
   
               showLoading(true);
               
               try {
                   const file = currentZip.files[filePath];
                   const fileName = filePath.split('/').pop();
                   
                   // –ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º
                   const fileInfo = {
                       name: fileName,
                       size: file._data.uncompressedSize
                   };
                   
                   const securityWarnings = analyzeFileSecurity(fileInfo);
                   
                   contentFileName.textContent = filePath;
                   
                   // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                   const securityHTML = displaySecurityWarnings(securityWarnings, fileName);
                   
                   // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
                   if (securityWarnings.length > 0) {
                       fileContent.classList.add('suspicious-file');
                   } else {
                       fileContent.classList.remove('suspicious-file');
                   }
                   
                   // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ñ–∞–π–ª —Ç–µ–∫—Å—Ç–æ–≤—ã–º
                   const extension = filePath.split('.').pop().toLowerCase();
                   const textExtensions = ['txt', 'md', 'c', 'h', 'cpp', 'hpp', 'js', 'html', 'css', 'py', 'java', 'json', 'xml', 'csv', 'log', 'cfg', 'conf', 'ini', 'rs', 'asm'];
                   
                   if (textExtensions.includes(extension)) {
                       const content = await file.async('text');
                       contentText.textContent = content;
                       contentText.style.display = 'block';
                       fileContent.querySelector('.binary-warning')?.remove();
                       
                       // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
                       if (checkSuspiciousContent(content)) {
                           const suspiciousWarning = document.createElement('div');
                           suspiciousWarning.className = 'security-warning';
                           suspiciousWarning.innerHTML = `
                               <strong>‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ!</strong>
                               <p>–§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç —à–∞–±–ª–æ–Ω—ã, –ø–æ—Ö–æ–∂–∏–µ –Ω–∞ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π –∫–æ–¥.</p>
                           `;
                           contentText.parentNode.insertBefore(suspiciousWarning, contentText);
                       }
                   } else {
                       contentText.style.display = 'none';
                       if (!fileContent.querySelector('.binary-warning')) {
                           const warning = document.createElement('div');
                           warning.className = 'binary-warning';
                           warning.innerHTML = `
                               <div style="font-size: 3rem; margin-bottom: 10px;">üîí</div>
                               <p>–≠—Ç–æ—Ç —Ñ–∞–π–ª –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω –∫–∞–∫ —Ç–µ–∫—Å—Ç</p>
                               <p style="font-size: 0.8rem; margin-top: 10px;">–§–æ—Ä–º–∞—Ç: ${extension || '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}</p>
                               ${securityHTML}
                           `;
                           fileContent.appendChild(warning);
                       }
                   }
                   
                   fileContent.style.display = 'block';
                   fileContent.scrollIntoView({ behavior: 'smooth' });
                   
               } catch (error) {
                   console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞:', error);
                   contentText.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞';
               }
               
               showLoading(false);
           }
   
           // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
           function checkSuspiciousContent(content) {
               const suspiciousPatterns = [
                   /eval\s*\(/i,
                   /document\.write/gi,
                   /fromCharCode/gi,
                   /unescape/gi,
                   /exec\s*\(/gi,
                   /system\s*\(/gi,
                   /cmd\.exe/gi,
                   /powershell/gi,
                   /wscript\.shell/gi,
                   /regsvr32/gi,
                   /schtasks/gi,
                   /base64_decode/gi
               ];
               
               return suspiciousPatterns.some(pattern => pattern.test(content));
           }
   
           // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∞–π–ª–æ–≤
           function markSuspiciousFiles(files) {
               files.forEach(path => {
                   if (!path.endsWith('/')) {
                       const fileName = path.split('/').pop();
                       const fileInfo = { name: fileName, size: 0 };
                       const warnings = analyzeFileSecurity(fileInfo);
                       
                       if (warnings.length > 0) {
                           // –ü–æ–º–µ—á–∞–µ–º –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
                           const fileElement = document.querySelector(`[data-path="${path}"]`);
                           if (fileElement) {
                               fileElement.classList.add('suspicious-file');
                               const warningSpan = document.createElement('span');
                               warningSpan.className = 'file-warning';
                               warningSpan.textContent = '‚ö†Ô∏è';
                               warningSpan.title = warnings.map(w => w.message).join(', ');
                               fileElement.appendChild(warningSpan);
                           }
                       }
                   }
               });
           }
       </script>
   </body>
   </html>
</body>
</html>
